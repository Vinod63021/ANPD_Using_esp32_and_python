<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live ALPR Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-green { 0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); } 50% { opacity: 0.8; box-shadow: 0 0 0 8px rgba(74, 222, 128, 0); } }
        .animate-pulse-green { animation: pulse-green 2s infinite; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased font-sans">

    <header class="bg-gray-800 shadow-md sticky top-0 z-10">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold text-white flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2 text-blue-400">
                    <path fill-rule="evenodd" d="M2 3.5A1.5 1.5 0 0 1 3.5 2h13A1.5 1.5 0 0 1 18 3.5v10.75a.75.75 0 0 1-1.5 0V8.75H3.5a.75.75 0 0 0 0 1.5h13V16.5A1.5 1.5 0 0 1 16.5 18h-13A1.5 1.5 0 0 1 2 16.5v-13Zm1.5 0h13a.75.75 0 0 1 0 1.5h-13a.75.75 0 0 1 0-1.5Z" clip-rule="evenodd" />
                  </svg>
                Live License Plate Reader
            </h1>
            <div id="fps-display" class="text-sm text-gray-400 font-mono">FPS: --</div>
        </div>
    </header>

    <div class="container mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-6">

        <div class="lg:col-span-2 space-y-6">
            <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden border border-gray-700">
                <div class="p-3 border-b border-gray-700 flex justify-between items-center">
                    <h2 class="text-lg font-semibold flex items-center">Live Video Feed</h2>
                    <span id="status-badge" class="px-3 py-1 rounded-full text-xs font-medium uppercase tracking-wider shadow bg-gray-600">Connecting...</span>
                </div>
                <div class="relative bg-black aspect-video">
                    <img id="video-stream" src="/video_feed" alt="Video Stream Paused or Loading..." class="w-full h-full object-contain" onerror="this.alt='❌ Error loading video stream. Check connection or app logs.'; this.style.display='none'; document.getElementById('paused-overlay').style.display='flex';">
                    <div id="paused-overlay" class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden">
                        <h3 class="text-2xl font-bold text-white opacity-80">STREAM ERROR</h3>
                    </div>
                </div>
            </div>
            <div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700">
                 <div class="p-3 border-b border-gray-700"><h2 class="text-lg font-semibold">AI Model Status</h2></div>
                <div class="p-4 grid grid-cols-1 sm:grid-cols-2 gap-2 text-center text-xs">
                    <div>Plate Detector (YOLO): <span id="model-yolo" class="font-bold text-gray-500">INIT</span></div>
                    <div>Text Reader (EasyOCR): <span id="model-ocr" class="font-bold text-gray-500">INIT</span></div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-1 space-y-6">
            <div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700">
                 <div class="p-3 border-b border-gray-700"><h2 class="text-lg font-semibold">Last Plate Detected</h2></div>
                <div class="p-6 flex flex-col items-center justify-center space-y-2 min-h-[150px]">
                    <div id="plate-text" class="text-6xl font-bold text-blue-400 font-mono tracking-widest text-center">---</div>
                    <div id="last-seen" class="text-xl font-medium text-gray-400 text-center">Never</div>
                </div>
            </div>
            </div>
    </div>

    <script>
        let updateInterval;
        
        // --- DOM Elements ---
        const fpsDisplay = document.getElementById('fps-display');
        const statusBadge = document.getElementById('status-badge');
        const plateTextEl = document.getElementById('plate-text');
        const lastSeenEl = document.getElementById('last-seen');
        const modelYoloEl = document.getElementById('model-yolo');
        const modelOcrEl = document.getElementById('model-ocr');
        
        async function updateDashboard() {
            try {
                const response = await fetch('/get_status');
                if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                const data = await response.json();

                updateBadge(data.is_live);
                updatePlatePanel(data.plate_text, data.last_seen);
                updateModelStatus(data.models_loaded);
                fpsDisplay.textContent = `FPS: ${data.fps.toFixed(1)}`;

            } catch (error) {
                console.error("Fetch error:", error);
                updateBadge(false);
                updatePlatePanel("ERROR", "Connection Failed");
                updateModelStatus(null);
                fpsDisplay.textContent = 'FPS: --';
            }
        }

        function updateBadge(isLive) {
            statusBadge.classList.remove('animate-pulse-green', 'bg-green-600', 'bg-yellow-500', 'bg-gray-500');
            if (isLive) {
                statusBadge.textContent = "LIVE"; statusBadge.classList.add('bg-green-600', 'animate-pulse-green');
            } else {
                 statusBadge.textContent = "OFFLINE"; statusBadge.classList.add('bg-gray-500');
            }
        }

        function updatePlatePanel(plateText, lastSeen) {
            plateTextEl.textContent = plateText || "---";
            lastSeenEl.textContent = `Last Seen: ${lastSeen || "Never"}`;
        }

         function updateModelStatus(models) {
            const updateEl = (el, status)_key) => {
                if (!el) return;
                el.textContent = status ? '✅ ON' : '❌ OFF';
                el.className = `font-bold ${status ? 'text-green-400' : 'text-red-400'}`;
            };
             if (models) {
                updateEl(modelYoloEl, models.yolo_plate); // Use correct key
                updateEl(modelOcrEl, models.ocr); // Use correct key
             } else {
                updateEl(modelYoloEl, false); updateEl(modelOcrEl, false);
                if(modelYoloEl) modelYoloEl.textContent = 'ERR';
                if(modelOcrEl) modelOcrEl.textContent = 'ERR';
             }
        }

        function init() {
             console.log("Initializing ALPR Dashboard...");
             if(updateInterval) clearInterval(updateInterval);
             updateDashboard();
             updateInterval = setInterval(updateDashboard, 1000); // Poll status every second
        }
        window.onload = init;
    </script>
</body>
</html>